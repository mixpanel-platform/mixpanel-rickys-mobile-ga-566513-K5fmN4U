<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js?a=1"></script>
  </head>
  <body class="mixpanel-platform-body">
    <h1>Transactional Funnels</h1>
    <div class="events_label">Funnel Steps:</div>
    <div id="dates"></div>
    <input id="event_list" value="App Open,Game Played,Session End">
    <button id="run_button">Run query</button>
    <div id="chart_div"></div>
        <script type="text/cq" id="cq">
var steps = params.event_list || ["App Open", "Game Played", "In-App Purchase", "Session End"]
var time_to_complete = 2000000
function main() {
    return Events({to_date:params.to_date, from_date:params.from_date})
        .groupByUser(function(state, events){
            var state = state || {start:0}
            for (var i=0; i<events.length; i++){
                if (events[i].name == steps[0]){
                    state[events[i].name] = state[events[i].name] || 0;
                    state[events[i].name]++
                    state.start = 1
                    state.time = events[i].time
                }
                if (state.start == steps.length || (events[i].time - state.time) > time_to_complete){
                    state.start = 0;
                }
                if (events[i].name == steps[state.start] && state.start != 0){
                    state.start += 1
                    state[events[i].name] = state[events[i].name] || 0;
                    state[events[i].name]++
                }    
            }
            return state
        })
        .reduce(function(accumulators, items){
            var result = {}
            for (var i=0; i<items.length; i++){
                for (step in items[i].value){
                    result[step] = result[step] || 0;
                    result[step] += items[i].value[step]; 
                }
            }
            for (var i=0; i<accumulators.length; i++){
                for (step in accumulators[i]){
                    result[step] = result[step] || 0;
                    result[step] += accumulators[i][step]
                }
            }
            return result
        })
        .map(function(item){
            var result = {}
            for (step in steps){
                result[steps[step]] = item[steps[step]]
                if (step > 0){
                    result[step] = (item[steps[step]] / item[steps[step-1]]).toFixed(2)
                }
            }
            return result
        })
}
    </script>
    <script>
      $('#dates').MPDatepicker();
      var script = $('#cq').html();
      script = $.trim(script);
      function date_to_string(d) {
        return d.toISOString().split('T')[0];
      }
      function drawFunnel(){
        google.load('visualization', '1', {packages: ['corechart', 'bar']});
google.setOnLoadCallback(drawColColors);

function drawColColors() {
      var data = new google.visualization.DataTable();
      data.addColumn('timeofday', 'Time of Day');
      data.addColumn('number', 'Motivation Level');
      data.addColumn('number', 'Energy Level');

      data.addRows([
        [{v: [8, 0, 0], f: '8 am'}, 1, .25],
        [{v: [9, 0, 0], f: '9 am'}, 2, .5],
        [{v: [10, 0, 0], f:'10 am'}, 3, 1],
        [{v: [11, 0, 0], f: '11 am'}, 4, 2.25],
        [{v: [12, 0, 0], f: '12 pm'}, 5, 2.25],
        [{v: [13, 0, 0], f: '1 pm'}, 6, 3],
        [{v: [14, 0, 0], f: '2 pm'}, 7, 4],
        [{v: [15, 0, 0], f: '3 pm'}, 8, 5.25],
        [{v: [16, 0, 0], f: '4 pm'}, 9, 7.5],
        [{v: [17, 0, 0], f: '5 pm'}, 10, 10],
      ]);

      var options = {
        title: 'Motivation and Energy Level Throughout the Day',
        colors: ['#9575cd', '#33ac71'],
        hAxis: {
          title: 'Time of Day',
          format: 'h:mm a',
          viewWindow: {
            min: [7, 30, 0],
            max: [17, 30, 0]
          }
        },
        vAxis: {
          title: 'Rating (scale of 1-10)'
        }
      };

      var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
      chart.draw(data, options);
    }
      }
      function runQuery(){
        var event_list = $('#event_list').val().split(',');
        var dateVal = $('#dates').val();
        var queryParams = {
          from_date: date_to_string(dateVal.from),
          to_date: date_to_string(dateVal.to),
          event_list:event_list
        };
        MP.api.custom_query(script, queryParams).done(function(results) {
            cqResult = results[0];
            console.log(cqResult)
            drawFunnel()
        })
      }
      $("#run_button").on('click', function() {
        runQuery();
      })
      $('#dates').on('change', function() {
        runQuery();
      });
      // Run queries and display results here
    </script>
  </body>
</html>
